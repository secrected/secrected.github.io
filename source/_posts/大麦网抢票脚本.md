---
title: 大麦网抢票辅助脚本
date: 2019-09-26 13:46:30  
categories: [life]
tags: 抢票
---

> 然而令人失望的是：因为是安装在电脑浏览器上的js脚本，所以只支持常规抢票，比如答题类、选座类的抢票就无能为力了，并且首先抢票项目得支持pc端下单。

这个方法参考自[Greasy Fork](https://greasyfork.org/zh-CN/scripts?q=%E5%A4%A7%E9%BA%A6)  有耐心的朋友自己参照安装即可。不过对于小白来说最喜欢简单暴力了，下面介绍步骤，不需要的自行跳过

<!--more-->

#### 第一步：安装浏览器脚本管理器

谷歌浏览器-->打开网址[谷歌商店--暴力猴](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)  安装扩展程序（火狐浏览器--[点击这里](https://addons.mozilla.org/zh-CN/firefox/addon/greasemonkey/)），这里可能网址无法访问，因为谷歌商店是需要翻墙连外网的，这里装个翻墙软件即可：

Lantern是Google开发的梯子。下载即用，简单到极致——无奈免费版限流限速，不过在这里足够用了。官网（[Lantern官网](https://getlantern.org/)）或免翻墙的Github（[Lantern最新版本下载](https://github.com/getlantern/forum#%E8%93%9D%E7%81%AFlantern%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E4%B8%8B%E8%BD%BD)）下载。安装后打开浏览器弹出页右下角出现绿色connected就可以了：

![](/pho/article/landeng.jpg)

出于各种可描述和不可描述的理由，很多朋友需要翻墙。github上有众多梯子（翻墙工具）从速度慢的Shadowsocks，Lantern到免费的XX-Net这里不介绍了，需要的朋友自行搜索。

#### 第二步：安装脚本

这里以谷歌浏览器为例，火狐类似。点击第一步安装后浏览器工具栏右侧出现的图标，添加脚本：

![](/pho/article/xjjb.jpg)

然后全选复制粘贴以下代码：

```
// ==UserScript==
// @name         场次票价人数
// @namespace    https://www.jwang0614.top/scripts
// @version      0.7.2
// @description  辅助购买大麦网演唱会门票
// @author       Olivia Wang
// @match        https://detail.damai.cn/*
// @grant        none
// @require      http://code.jquery.com/jquery-1.11.1.min.js
// ==/UserScript==

var sellStartTime_timestamp = null;
var order_url = null;
var timer = null;

$(document).ready(function(){
    var data = sessionStorage.getItem('order_url');
    if (data) {
        window.location.href = data;
    } else {
        var service_note_name_seat = $('.service-note .service-note-name:first').text().trim();
        // var service_note_name_express = $('.service-note div.service-note-name')[1].textContent.trim();

        if($("div.buybtn").text() === "选座购买" || service_note_name_seat === "可选座"){
            alert("目前不支持选座");
        }
        // else if(service_note_name_express !== "快递票"){
        //     alert("目前只支持快递票");
        // }
        else {
            insert_ui();
        }
    }



});

function insert_ui() {
    var $service = $(".content-right .service");

    var $style = $('<style>'+
        '#control_container{margin: 20px 0; background:#e9e9e9;padding:20px 0;}'+
        '#control_container button{width:80%;margin:10px 10%;padding:10px 0;font-size:30px;border-style: solid;}'+
        '#start_btn{color:green;}'+
        '#end_btn{color:red;}'+
        '#number_input_wrapper{display: flex;justify-content:center;font-size: 20px; margin-bottom:20px;}'+
        '#notice{margin:10px 10px;padding:10px 10px;color:darkslategrey;border-style: solid; border-width: 1px; border-color:darkslategrey;}'+
        '#countdown_wrapper {display:none; font-size: 16px; text-align:center; background:#ffeaf1;}'+
        '#countdown_wrapper p{width:100%;}'+
        '#countdown {font-size: 20px; color:#ff1268;}'+
        '</style>');

    var $control_container = $("<div id='control_container'></div>");


    var $number_input = $('<div id="number_input_wrapper">请输入人数：<input id="number_input" type="number" value="1" min="1" max="6"></div>');
    var $start_btn = $('<button id="start_btn">开始抢票</button>');
    var $end_btn = $('<button id="end_btn">停止抢票</button>');
    var $notice = $('<div id="notice"><h3>使用步骤</h3><p>0.登录，填写购票人信息</p><p>1.选择场次</p><p>2.选择价格</p><p>3.填写人数</p><p>4.点击‘开始抢票’</p></div>');

    var $countdown = $('<div id="countdown_wrapper"><p id="selected_event">event1</p><p id="selected_price">price2</p><p id="selected_number">1人</p><br><p>倒计时:</p><p id="countdown">00:00:00</p></div>');
    $control_container.append($style);
    $control_container.append($number_input);
    $control_container.append($start_btn);
    $control_container.append($end_btn);
    $control_container.append($notice);
    // $control_container.append($countdown);

    $control_container.insertBefore($service);
    $countdown.insertBefore($control_container);

    $("#start_btn").click(function(){
        var event = $(".perform__order__select.perform__order__select__performs .select_right_list .active span:last-of-type").text();
        var price = $(".select_right_list_item.sku_item.active .skuname").text();
        var people_num = $("#number_input").val();
        var data_json = JSON.parse($("#dataDefault").text());
        window.sellStartTime_timestamp = data_json["sellStartTime"];

        // console.log("sellStartTime_timestamp: " + sellStartTime_timestamp);
        // console.log("now: " + Date.now());

        // console.log(data_json);

        $("#selected_event").text(event);
        $("#selected_price").text(price);
        $("#selected_number").text(people_num + "人");

        $("#countdown_wrapper").show();


        var result = generate_confirm_url(event, price, people_num,data_json);

        if(result) {
            window.order_url = result;
            sessionStorage.setItem('order_url', result);

            console.log("countdown and go to confirm page");
            timedUpdate();


        } else {
            console.error("不知道为什么获取场次票价人数出错了呢。");
            alert("不知道为什么获取场次票价人数出错了呢。");

        }





    });

    $("#end_btn").click(function(){
        clearTimeout(window.timer);
        $("#countdown_wrapper").hide();
        sessionStorage.clear();
    });

}

function generate_confirm_url(event, price, people_num, data_json) {
    var performBases = data_json["performBases"];
    var itemId = "";

    for(var i=0; i<performBases.length; i++) {
        var performBase = performBases[i];
        var performs = performBase["performs"];
        for(var j=0; j<performs.length; j++) {
            var perform = performs[j];
            if(perform["performName"] === event) {
                itemId = perform["itemId"];
                var skuList = perform["skuList"];
                for(var k=0; k<skuList.length; k++) {
                    var skuList_item = skuList[k];
                    if(skuList_item["skuName"] === price) {
                        var skuId = skuList_item["skuId"];
                        return "https://buy.damai.cn/orderConfirm?exParams=%7B%22damai%22%3A%221%22%2C%22channel%22%3A%22damai_app%22%2C%22umpChannel%22%3A%2210002%22%2C%22atomSplit%22%3A%221%22%2C%22serviceVersion%22%3A%221.8.5%22%7D&buyParam=" + itemId + "_" + people_num + "_" + skuId + "&buyNow=true&spm=a2oeg.project.projectinfo.dbuy"

                    }
                }

            }
        }

    }
    return null;

}

function timedUpdate() {
    // 提前2秒开始
    var current_time = Date.now();
    var time_difference = Math.ceil((window.sellStartTime_timestamp - current_time)/1000);
    if (time_difference < 2) {
        window.location.href = window.order_url;
    } else {
        var time_difference_str = time_difference.toHHMMSS();
        $("#countdown").text(time_difference_str);

        window.timer = setTimeout(timedUpdate, 1000);

    }

}


//https://stackoverflow.com/a/31112615
Number.prototype.toHHMMSS = function() {
    var hours = Math.floor(this / 3600) < 10 ? ("00" + Math.floor(this / 3600)).slice(-2) : Math.floor(this / 3600);
    var minutes = ("00" + Math.floor((this % 3600) / 60)).slice(-2);
    var seconds = ("00" + (this % 3600) % 60).slice(-2);
    return hours + ":" + minutes + ":" + seconds;
};
```

然后保存。一个脚本对应一个网址，类似再依次添加两个脚本：

```
// ==UserScript==
// @name         抢票-确认
// @namespace    https://www.jwang0614.top/scripts
// @version      0.7.2
// @description  辅助购买大麦网演唱会门票
// @author       Olivia Wang
// @match        https://buy.damai.cn/orderConfirm*
// @grant        none
// @require      http://code.jquery.com/jquery-1.11.1.min.js
// ==/UserScript==


var test_url = "https://buy.damai.cn/orderConfirm?exParams=%7B%22damai%22%3A%221%22%2C%22channel%22%3A%22damai_app%22%2C%22umpChannel%22%3A%2210002%22%2C%22atomSplit%22%3A%221%22%2C%22serviceVersion%22%3A%221.8.5%22%7D&buyParam=600583263497_1_4192587404863&buyNow=true&spm=a2oeg.project.projectinfo.dbuy"
var timer = null;
var current_url = null;


var max_time = 300;
var current_time = 100;

$(document).ready(function(){
    window.current_url = window.location.href;
    if($(".error-msg").length > 0) {
        window.location.reload();
        // console.log("error");
    } else {
        fill_form();
    }

});



function fill_form() {
    var input = document.querySelector(".delivery-email-form input");
    var email = "";

    if (input) {

        input.value=email;

    }

    var buyer_number = parseInt($(".ticket-buyer-title em").text());
    console.log(buyer_number);
    var buyer_list = $(".buyer-list-item input");
    for(var i=0; i < buyer_number; i++) {
        console.log(buyer_list[i]);
        buyer_list[i].click();
    }

    $(".submit-wrapper button").click();
    setTimeout(check_alert, 100);

}


function check_alert() {
    var alerts = $(".next-dialog-alert");
    if(alerts.length > 0 || window.current_time >= window.max_time) {
        window.location.reload();
    } else {
        window.current_time = window.current_time + 100;
        setTimeout(check_alert, 100);
    }
}
```

```
// ==UserScript==
// @name         挤爆了
// @namespace    https://www.jwang0614.top/scripts
// @version      0.1.0
// @description  辅助购买大麦网演唱会门票
// @author       Olivia Wang
// @match        https://buy.damai.cn/multi/flow?http_referer=*
// @grant        none
// @require      http://code.jquery.com/jquery-1.11.1.min.js
// ==/UserScript==


var original_str = window.location.href;
var dest_url = original_str.replace("https://buy.damai.cn/multi/flow?http_referer=", "")

window.location.href = dest_url;
```

最后完成如图：

![](/pho/article/jblb.jpg)

只安装这三个即可

#### 第三步：完成测试

先登录大麦网，选择一个抢票项目，出现如图：

![](/pho/article/detail.jpg)

为确保无误，可先选一个有票的抢票项目，点击开始抢票，从这样的详情页跳转到提交订单页，最后到达支付页面，订单锁定即是成功。

#### 后续

因为浏览器访问这种网址都是需要DNS解析的，为了节省这么一丢丢解析时间，还可以把大麦网相关网址的ip映射`添加`到`hosts`文件中（不清楚百度本机hosts文件位置）：

```
203.119.211.252  detail.damai.cn 
203.119.207.123  buy.damai.cn
```

ip如果换了自己这样 `ping  detail.damai.cn` 在命令行窗口ping一下哦

最后，抢票不易，需要多磨，很大程度上取决于运气、网速、手速等，挂网站脚本也不一定如愿，配合手机，多账号同时抢提高概率吧。

欢迎有经验的朋友分享交流
